name: Supabase Ping

on:
  workflow_dispatch:

jobs:
  ping-supabase:
    runs-on: ubuntu-latest
    steps:
      - name: 🔁 Ping Supabase tables
        run: |
          echo "🔁 Supabase 複数テーブルの ping を開始します..."

          # 現在の日時を取得（日本時間に変換）
          now=$(TZ=Asia/Tokyo date "+%Y-%m-%d %H:%M:%S")

          # テスト用に存在しないテーブル名で通知をテスト（本番では users_ffprod 等に戻す）
          for table in users_ffprod users_ffdev users_prod users_invalid_table; do
            echo ""
            echo "🔸 $table を ping 中..."
            status=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
              "${{ secrets.SUPABASE_PROJECT_URL }}/rest/v1/$table")

            echo "✅ [$table] → ステータスコード: $status"

            if [ "$status" != "200" ]; then
              echo "⚠️ [$table] はステータス200ではありません！"
              echo "::warning file=ping-supabase.yml::[$table] のステータス: $status"

              # 🔔 Discord に1行で通知（日時含む）
              curl -X POST -H "Content-Type: application/json" \
                -d "{\"content\":\"⚠️ Supabase ping失敗 [$table] - ステータス: $status（$now JST）\"}" \
                "${{ secrets.DISCORD_WEBHOOK_URL }}"
            fi
          done
