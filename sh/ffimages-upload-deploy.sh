#!/bin/bash
# ffscripts/sh/ffimages-upload-deploy.sh
# âœ… ç”»åƒã‚’ GitHub ã« push ã—ã€Cloudflare Pages ã«æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å®‰å…¨ç¢ºèªä»˜ãã‚¹ã‚¯ãƒªãƒ—ãƒˆ
#
# âœ… ç›®çš„ï¼š
# inuichiba-ffimages ã«å…¥ã‚ŒãŸç”»åƒã‚’ GitHub ã¸ç™»éŒ²ã—ã€
# Cloudflare Pages ã§å…¬é–‹ãƒ»CDNã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ€æ–°ã«æ›´æ–°ã™ã‚‹ã€‚
#
# âœ… é‡è¦ï¼š
# - ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ git push ã®ã‚ã¨ npx wrangler ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ Cloudflare Pages ãŒå†ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚
# - ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã™ã‚‹ã¨ã€Cloudflare ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆCDNã‚¨ãƒƒã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ã‚‚è‡ªå‹•ã§æ›´æ–°ã•ã‚Œã¾ã™ã€‚
# - ãã®ãŸã‚ **ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰ãˆãªãã¦ã‚‚æœ€æ–°ã®ç”»åƒãŒåæ˜ ã•ã‚Œã¾ã™**ã€‚
# - ç”»åƒå¤‰æ›´ãªã—ã®å ´åˆã€GitHubã¸ã®Pushã¯è¡Œã„ã¾ã™ãŒ Cloudflare Pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚
# - ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œã¯æ‰‹å‹•ç¢ºèªã«ã‚ˆã‚‹ã€Œç”»åƒã‚ã‚Š (Y)ã€å›ç­”ã«åŸºã¥ããƒ•ãƒ©ã‚°åˆ¶å¾¡ã§åˆ¤å®šã•ã‚Œã¾ã™ã€‚
#
# âœ… ãƒã‚¤ãƒ³ãƒˆï¼š
# - Pushæ™‚ã¯è‰²ä»˜ãã§é€²è¡ŒçŠ¶æ³ã‚’è¡¨ç¤ºï¼ˆå®‰å¿ƒã®è¦‹ãˆã‚‹åŒ–ï¼‰
# - PushæˆåŠŸ/å¤±æ•—ã‚’è‰²åˆ†ã‘ï¼ˆæˆåŠŸ=ç·‘ã€å¤±æ•—=èµ¤ã§æ˜ç¢ºã«ï¼‰
# - git status ã‚‚è¡¨ç¤ºã—ã¦ç¾çŠ¶ç¢ºèª
# - npx wrangler login æ¸ˆã§ã‚ã‚‹ã“ã¨
#
# âœ… 1. Macãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †
#
# â–¼ ã‚¹ã‚¯ãƒªãƒ—ãƒˆé…ç½®ï¼ˆGitã§å–å¾—ã—ãŸãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆï¼‰:
# inuichiba-ffscripts/
# â”œâ”€ sh/
# â”‚  â””â”€ ffimages-upload-deploy.sh
#
# â–¼ å®Ÿè¡Œæ¨©é™ã®ä»˜ä¸ï¼ˆåˆå›ã®ã¿ï¼‰
# cd ~/nasubi/inuichiba-ffscripts/sh/
# chmod +x ffimages-upload-deploy.sh
#
# â–¼ å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰
# cd ~/nasubi/inuichiba-ffimages
# ../inuichiba-ffscripts/sh/ffimages-upload-deploy.sh


set -e

# --------------------------------------------
# âœ… åˆæœŸè¨­å®š
# --------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$SCRIPT_DIR/../../inuichiba-ffimages"
DEPLOY_ENABLED=false

# --------------------------------------------
# âœ… ãƒªãƒã‚¸ãƒˆãƒªç§»å‹•
# --------------------------------------------
echo -e "\nğŸ“‚ Gitæ“ä½œå¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ä¸­: $PROJECT_ROOT"
cd "$PROJECT_ROOT"

# --------------------------------------------
# âœ… ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç§»å‹•ï¼ˆã“ã®ä¸­ã§gitæ“ä½œï¼‰
# --------------------------------------------
echo "\nğŸ“‚ Gitæ“ä½œå¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ä¸­: ../inuichiba-ffimages"
cd ../inuichiba-ffimages || exit 1

# --------------------------------------------
# âœ… ãƒ–ãƒ©ãƒ³ãƒç¢ºèª
# --------------------------------------------
branch=$(git rev-parse --abbrev-ref HEAD)
echo -e "\nğŸ“ ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: $branch"
if [[ "$branch" != "main" ]]; then
  echo "ğŸš« pushã¯mainãƒ–ãƒ©ãƒ³ãƒã§ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã¾ã™ã€‚"
  cd "$SCRIPT_DIR/.."
  exit 1
fi

# --------------------------------------------
# ğŸ”„ å·®åˆ†ç¢ºèª
# --------------------------------------------
echo -e "\nğŸ”„ ãƒªãƒ¢ãƒ¼ãƒˆã¨ã®å·®åˆ†ãƒã‚§ãƒƒã‚¯..."
git fetch origin
remote_diff=$(git log HEAD..origin/main --oneline)
if [[ -n "$remote_diff" ]]; then
  echo "âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ã¨ãƒªãƒ¢ãƒ¼ãƒˆã«å·®åˆ†ãŒã‚ã‚Šã¾ã™ã€‚pull/rebaseã—ã¦ã‹ã‚‰å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
  cd "$SCRIPT_DIR/.."
  exit 1
fi

# --------------------------------------------
# âœ… git status ã®ç¢ºèªï¼ˆ60ç§’é–“ã®ç¢ºèªã‚¿ã‚¤ãƒ ï¼‰
# --------------------------------------------
# ğŸ“¦ å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ›´ãŒãªã‘ã‚Œã°çµ‚äº†ï¼‰
if git diff --quiet && git diff --cached --quiet; then
  echo "âš ï¸ å¤‰æ›´ãŒãªã„ãŸã‚ã€git ãŠã‚ˆã³ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚"
  cd ../inuichiba-ffscripts || exit 1
fi

echo "\nğŸ“Š 30ç§’é–“ãŠå¾…ã¡ã—ã¾ã™... ç‰¹ã«ç”»åƒã«å¤‰æ›´ãŒãªã„ã‹ã˜ã£ãã‚Šç¢ºèªã—ã¦ãã ã•ã„ã€‚"
git status
for i in $(seq 30 -1 1); do
  echo -ne "â³ æ®‹ã‚Š $i ç§’...\r"
  sleep 1
done

# --------------------------------------------
# âœ… ç”»åƒå¤‰æ›´ã®æœ‰ç„¡ã‚’ç¢ºèª
# ã“ã“ã§"Y/y"ã‚’å…¥åŠ›ã—ãŸã¨ãã®ã¿å¾Œã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
# --------------------------------------------
read -p $'\nğŸ–¼ ç”»åƒã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ (Y/N): ' confirm
if [[ "$confirm" =~ ^[Yy]$ ]]; then
  DEPLOY_ENABLED=true
fi

# --------------------------------------------
# âœ… ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å…¥åŠ›
# --------------------------------------------
echo "\nğŸ”¸ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š"
echo "   (ç”»åƒæ›´æ–°ã ã‘ãªã‚‰ã€ç”»åƒæ›´æ–°ã€ã§ã‚‚æ§‹ã„ã¾ã›ã‚“)"
read -p "> " commit_msg

# --------------------------------------------
# âœ… git add â†’ commit â†’ push ã®ç¢ºèª
# --------------------------------------------
read -p $'\nâš ï¸ ç¶šã‘ã¦ git add -A â†’ commit â†’ push ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ (Y/N): ' confirm2
echo
if [[ ! "$confirm2" =~ ^[Yy]$ ]]; then
  echo "ğŸš« ä¸­æ­¢ã—ã¾ã—ãŸã€‚å®‰å¿ƒã—ã¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚"
  cd ../inuichiba-ffscripts || exit 0
fi

# --------------------------------------------
# âœ… git add, commit, push
# --------------------------------------------
echo "ğŸ“ ã™ã¹ã¦ã®è¿½åŠ ãƒ»å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ã«åæ˜ (ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°)ã—ã¾ã™..."
echo -e "ğŸ“¥ git add -A å®Ÿè¡Œä¸­..."
git add -A

timestamp=$(date "+%Y%m%d-%H%M")
echo "ğŸš€ ã‚³ãƒŸãƒƒãƒˆã‚’å®Ÿè¡Œã—ã¾ã™: '$commit_msg : $timestamp'"
git commit -m "$commit_msg : $timestamp"

echo -e "\nğŸš€ git push origin main å®Ÿè¡Œä¸­..."
push_output=$(git push origin main 2>&1 | tee /dev/tty)

if echo "$push_output" | grep -q "To "; then
  echo "âœ… Push æˆåŠŸï¼"

  if $DEPLOY_ENABLED; then
    echo -e "\nğŸš€ Cloudflare Pages ã¸æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹..."
    cd "$SCRIPT_DIR/.."
    npx wrangler pages deploy
  else
    echo "ğŸ’¤ ç”»åƒã«å¤‰æ›´ãŒãªã„ãŸã‚ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¯è¡Œã„ã¾ã›ã‚“ã§ã—ãŸã€‚"
  fi

else
  echo "âŒ Push ã«å¤±æ•—ã—ã¾ã—ãŸ"
  echo "ğŸ’¬ ã‚¨ãƒ©ãƒ¼å†…å®¹:"
  echo "$push_output"
  cd ../inuichiba-ffscripts || exit 1
fi

# --------------------------------------------
# âœ… æœ€å¾Œã«git statusè¡¨ç¤º
# --------------------------------------------
echo -e "\nğŸ“Š ç¾åœ¨ã®Gitã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:"
git status

cd "$SCRIPT_DIR/.."

