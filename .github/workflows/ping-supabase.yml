name: ğŸ” upabase user-tables Ping (every other day)
# ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸã¨ãã ã‘GitHubã‹ã‚‰ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãŒã‚ã‚‹ã¨ã¨ã‚‚ã«Discordã«é€šçŸ¥ã•ã‚Œã¾ã™ã€‚
# GitHub Secrets: DISCORD_WEBHOOK_URL ã‚’ä½¿ç”¨
# Cloudflare WorkersçµŒç”±ã®é€šçŸ¥ã¯å»ƒæ­¢ã—ã€ç„¡æ–™æ ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¶ˆè²»ã‚’å®Œå…¨ã«ã‚¼ãƒ­ã«æŠ‘ãˆã¦ã„ã¾ã™ã€‚
# Cloudflare WorkersçµŒç”±ã«æˆ»ã™ãªã‚‰ã€secretsï¼šWORKERS_NOTIFY_URL ã«ã™ã‚Œã°ã„ã„ã§ã™(ãŸã ã—èª²é‡‘æ ã«å…¥ã‚Šã¾ã™)ã€‚

on:
  schedule:
    - cron: '5 3 */2 * *'   # éš”æ—¥ï¼ˆUTC 03:05 = JST 12:05ï¼‰
  workflow_dispatch:

concurrency:
  group: supabase-ping
  cancel-in-progress: true

jobs:
  ping-supabase:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: ğŸ“¡ Ping tables (serial with diagnostics)
        run: |
          set -euo pipefail
          set -x

          failures=""
          for table in users_ffprod users_ffprod_archived users_ffdev; do
            echo ""
            echo "ğŸ”¸ $table ã‚’ ping ä¸­..."

            # ã‚¿ã‚¤ãƒŸãƒ³ã‚°è¨ˆæ¸¬ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            fmt='code=%{http_code} resolve=%{time_namelookup}s connect=%{time_connect}s starttx=%{time_starttransfer}s total=%{time_total}s'

            # è»½ã„ã‚¸ãƒƒã‚¿ãƒ¼ã§Runnerå´ã®ä¸€æ™‚è©°ã¾ã‚Šå›é¿ï¼ˆ0ã€œ2ç§’ï¼‰
            sleep $((RANDOM % 3))

            out=$(curl --connect-timeout 10 --max-time 60 \
              --retry 2 --retry-delay 2 --retry-connrefused \
              -L -s -o /dev/null -w "$fmt" \
              -H "apikey: $SUPABASE_KEY" \
              -H "Authorization: Bearer $SUPABASE_KEY" \
              "$SUPABASE_URL/rest/v1/$table?select=*&limit=1")

            echo "[$table] $out"

            code=$(echo "$out" | sed -n 's/.*code=\([0-9][0-9][0-9]\).*/\1/p')
            if [ "$code" != "200" ]; then
              failures="${failures}- ${table} â†’ $code\n"
            fi
          done

          if [ -n "$failures" ]; then
            now=$(TZ=Asia/Tokyo date "+%Y-%m-%d %H:%M:%S")
            payload="âš ï¸ Supabase pingå¤±æ•—ï¼ˆ$now JSTï¼‰\n$failures"
            curl -s -X POST -H "Content-Type: application/json" \
                 -d "{\"content\":\"$payload\"}" \
                 "$DISCORD_WEBHOOK_URL" || true
            exit 1
          fi

          echo "âœ… all ok"
