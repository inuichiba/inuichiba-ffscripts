name: ğŸ§® Supabaseæ›¸ãè¾¼ã¿ä»¶æ•°ãƒã‚§ãƒƒã‚¯ã¨KVèª²é‡‘è­¦å‘Šé€šçŸ¥ï¼ˆ5ä¸‡ä»¶ä¸­80%ï¼‰

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œç”¨ï¼ˆåˆæœŸç¢ºèªã‚„ãƒ†ã‚¹ãƒˆç”¨ï¼‰
  schedule:
    - cron: '30 0 * * *'  # æ¯æ—¥ JST 09:30ï¼ˆUTC 0:30ï¼‰

jobs:
  check-writecount:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ å¿…è¦ãªç’°å¢ƒã‚’æº–å‚™
        run: echo "âœ… ç’°å¢ƒæº–å‚™å®Œäº†"

      - name: ğŸ“¥ æœˆæ¬¡Supabaseæ›¸ãè¾¼ã¿ä»¶æ•°ã®ç¢ºèª
        run: |
          echo "ğŸ” æœˆæ¬¡æ›¸ãè¾¼ã¿ä»¶æ•°ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™..."

          declare -A kv_namespaces
          kv_namespaces[ffdev-users_kv]="4ebfa42f89f7478888677c5486b6b540"
          kv_namespaces[ffprod-users_kv]="9cc8cd1153a34a66a4e1bf313078664c"

          now=$(TZ=Asia/Tokyo date "+%Y-%m")
          threshold=1
          failures=""

          for kv in "${!kv_namespaces[@]}"; do
            ns_id=${kv_namespaces[$kv]}
            key="writeCount:$now"

            echo "ğŸ”¹ $kv ($ns_id) â†’ ã‚­ãƒ¼: $key"
            val=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/39914da7b7f259b59d901f0b57cc17cc/storage/kv/namespaces/$ns_id/values/$key" \
              -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}")

            # æ•°å€¤ã ã‘ã‚’æŠ½å‡ºï¼ˆæ•´æ•°ã§å§‹ã¾ã‚‹è¡Œã®ã¿ã‚’è¨±å¯ï¼‰
            count=$(echo "$val" | grep -Eo '^[0-9]+$')

            if [ -z "$count" ]; then
              echo "âŒ å–å¾—å¤±æ•—ã¾ãŸã¯ç„¡åŠ¹ãªå€¤: $val"
              failures+="\n[$kv] æ›¸ãè¾¼ã¿ä»¶æ•°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹: $valï¼‰"
              continue
            fi

            echo "ğŸ”¸ $key = $count ä»¶"

            if [ "$count" -gt "$threshold" ]; then
              failures+="\n[$kv] æ›¸ãè¾¼ã¿ä»¶æ•°ãŒå¤šã™ãã¾ã™: ${count}ä»¶ï¼ˆé–¾å€¤: ${threshold}ï¼‰"
            fi
          done

          if [ -n "$failures" ]; then
            now=$(TZ=Asia/Tokyo date "+%Y-%m-%d %H:%M:%S")
            payload="âš ï¸ Supabaseæ›¸ãè¾¼ã¿ä»¶æ•° è­¦å‘Šï¼ˆ$now JSTï¼‰\n$failures"

            echo -e "ğŸš¨ Discordé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™: \n$payload"

            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\":\"$payload\"}" \
              "${{ secrets.DISCORD_WEBHOOK_URL }}"

            echo "::error title=Supabaseæ›¸ãè¾¼ã¿ä»¶æ•°è­¦å‘Š::$payload"

            exit 1
          else
            echo "âœ… ä»¶æ•°ã¯ã™ã¹ã¦æ­£å¸¸ç¯„å›²ã§ã™"
          fi
