name: Supabase Ping

on:
  workflow_dispatch:

jobs:
  ping-supabase:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Ping Supabase tables
        run: |
          echo "ğŸ” Supabase è¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã® ping ã‚’é–‹å§‹ã—ã¾ã™..."

          # ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—ï¼ˆæ—¥æœ¬æ™‚é–“ã«å¤‰æ›ï¼‰
          now=$(TZ=Asia/Tokyo date "+%Y-%m-%d %H:%M:%S")

          # ãƒ†ã‚¹ãƒˆç”¨ã«å­˜åœ¨ã—ãªã„ãƒ†ãƒ¼ãƒ–ãƒ«åã§é€šçŸ¥ã‚’ãƒ†ã‚¹ãƒˆï¼ˆæœ¬ç•ªã§ã¯ users_ffprod ç­‰ã«æˆ»ã™ï¼‰
          for table in users_ffprod users_ffdev users_prod users_invalid_table; do
            echo ""
            echo "ğŸ”¸ $table ã‚’ ping ä¸­..."
            status=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
              "${{ secrets.SUPABASE_PROJECT_URL }}/rest/v1/$table")

            echo "âœ… [$table] â†’ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: $status"

            if [ "$status" != "200" ]; then
              echo "âš ï¸ [$table] ã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹200ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼"
              echo "::warning file=ping-supabase.yml::[$table] ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $status"

              # ğŸ”” Discord ã«1è¡Œã§é€šçŸ¥ï¼ˆæ—¥æ™‚å«ã‚€ï¼‰
              curl -X POST -H "Content-Type: application/json" \
                -d "{\"content\":\"âš ï¸ Supabase pingå¤±æ•— [$table] - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $statusï¼ˆ$now JSTï¼‰\"}" \
                "${{ secrets.DISCORD_WEBHOOK_URL }}"
            fi
          done
