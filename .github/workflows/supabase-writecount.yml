name: 🧮 Supabase書き込み件数チェックとKV課金警告通知（5万件中80%）

on:
  workflow_dispatch:  # 手動実行用（初期確認やテスト用）
  schedule:
    - cron: '30 0 * * *'  # 毎日 JST 09:30（UTC 0:30）

jobs:
  check-writecount:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 必要な環境を準備
        run: echo "✅ 環境準備完了"

      - name: 📥 月次Supabase書き込み件数の確認
        run: |
          echo "🔎 月次書き込み件数をチェックします..."

          declare -A kv_namespaces
          kv_namespaces[ffdev-users_kv]="4ebfa42f89f7478888677c5486b6b540"
          kv_namespaces[ffprod-users_kv]="9cc8cd1153a34a66a4e1bf313078664c"

          now=$(TZ=Asia/Tokyo date "+%Y-%m")
          threshold=1
          failures=""

          for kv in "${!kv_namespaces[@]}"; do
            ns_id=${kv_namespaces[$kv]}
            key="writeCount:$now"

            echo "🔹 $kv ($ns_id) → キー: $key"
            val=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/39914da7b7f259b59d901f0b57cc17cc/storage/kv/namespaces/$ns_id/values/$key" \
              -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}")

            # 数値だけを抽出（整数で始まる行のみを許可）
            count=$(echo "$val" | grep -Eo '^[0-9]+$')

            if [ -z "$count" ]; then
              echo "❌ 取得失敗または無効な値: $val"
              failures+="\n[$kv] 書き込み件数の取得に失敗しました（レスポンス: $val）"
              continue
            fi

            echo "🔸 $key = $count 件"

            if [ "$count" -gt "$threshold" ]; then
              failures+="\n[$kv] 書き込み件数が多すぎます: ${count}件（閾値: ${threshold}）"
            fi
          done

          if [ -n "$failures" ]; then
            now=$(TZ=Asia/Tokyo date "+%Y-%m-%d %H:%M:%S")
            payload="⚠️ Supabase書き込み件数 警告（$now JST）\n$failures"

            echo -e "🚨 Discord通知を送信します: \n$payload"

            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\":\"$payload\"}" \
              "${{ secrets.DISCORD_WEBHOOK_URL }}"

            echo "::error title=Supabase書き込み件数警告::$payload"

            exit 1
          else
            echo "✅ 件数はすべて正常範囲です"
          fi
