name: Weekly Supabase Ping
# ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸã¨ãã ã‘GitHubã‹ã‚‰ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãŒã‚ã‚‹ã¨ã¨ã‚‚ã«Discordã«é€šçŸ¥ã•ã‚Œã¾ã™ã€‚
# âœ… é€šçŸ¥å…ˆã¯Discordã«å¤‰æ›´æ¸ˆï¼ˆç›´æ¥é€ä¿¡ï¼‰
# Secrets: DISCORD_WEBHOOK_URL ã‚’ä½¿ç”¨
# Cloudflare WorkersçµŒç”±ã®é€šçŸ¥ã¯å»ƒæ­¢ã—ã€ç„¡æ–™æ ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¶ˆè²»ã‚’å®Œå…¨ã«ã‚¼ãƒ­ã«æŠ‘ãˆã¦ã„ã¾ã™ã€‚
# Cloudflare WorkersçµŒç”±ã«æˆ»ã™ãªã‚‰ã€secretsï¼šWORKERS_NOTIFY_URL ã«ã™ã‚Œã°ã„ã„ã§ã™(ãŸã ã—èª²é‡‘æ ã«å…¥ã‚Šã¾ã™)ã€‚

on:
  schedule:
    - cron: '0 0 1,5,10,15,20,25,30 * *'
  workflow_dispatch:

jobs:
  ping-supabase:
    runs-on: ubuntu-latest
    env:
      SUPABASE_PROJECT_URL: ${{ secrets.SUPABASE_PROJECT_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}  # Cloudflareå¯¾å¿œã¯WORKERS_NOTIFY_URL

    steps:
      - name: ğŸ” Ping Supabase tables
        run: |
          set -x
          echo "ğŸ” Supabase è¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã® ping ã‚’é–‹å§‹ã—ã¾ã™...($(date '+%Y-%m-%d %H:%M:%S'))"

          now=$(TZ=Asia/Tokyo date "+%Y-%m-%d %H:%M:%S")

          failures=""
          for table in users_ffprod users_ffdev users_prod users_fake; do
            echo ""
            echo "ğŸ”¸ $table ã‚’ ping ä¸­..."

            status=$(curl -L -s -o /dev/null -w "%{http_code}" \
              -H "apikey: $SUPABASE_ANON_KEY" \
              "$SUPABASE_PROJECT_URL/rest/v1/$table")

            echo "âœ… [$table] â†’ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: $status"

            if [ "$status" != "200" ]; then
              echo "âš ï¸ [$table] ã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹200ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼"
              failures="${failures}- ${table} â†’ $status\\n"
            fi
          done


          # å¤±æ•—ãŒã‚ã£ãŸã‚‰é€šçŸ¥ã—ã¦exit 1(ç•°å¸¸çµ‚äº†â†’GitHubãŒè‡ªå‹•ã§ãƒ¡ãƒ¼ãƒ«é€šçŸ¥)
          [ -n "$failures" ] && {
            now=$(TZ=Asia/Tokyo date "+%Y-%m-%d %H:%M:%S")
            payload="âš ï¸ Supabase pingå¤±æ•—ï¼ˆ$now JSTï¼‰\\n$failures"
            curl -s -X POST -H "Content-Type: application/json" \
                 -d "{\"content\":\"$payload\"}" \
                 "$DISCORD_WEBHOOK_URL"
            exit 1
          }
          
          echo "âœ… ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ­£å¸¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã—ãŸã€‚"
          exit 0
