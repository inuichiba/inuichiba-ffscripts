name: ğŸ” upabase user-tables Ping (every other day)
# ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸã¨ãã ã‘GitHubã‹ã‚‰ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãŒã‚ã‚‹ã¨ã¨ã‚‚ã«Discordã«é€šçŸ¥ã•ã‚Œã¾ã™ã€‚
# GitHub Secrets: DISCORD_WEBHOOK_URL ã‚’ä½¿ç”¨
# Cloudflare WorkersçµŒç”±ã®é€šçŸ¥ã¯å»ƒæ­¢ã—ã€ç„¡æ–™æ ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¶ˆè²»ã‚’å®Œå…¨ã«ã‚¼ãƒ­ã«æŠ‘ãˆã¦ã„ã¾ã™ã€‚
# Cloudflare WorkersçµŒç”±ã«æˆ»ã™ãªã‚‰ã€secretsï¼šWORKERS_NOTIFY_URL ã«ã™ã‚Œã°ã„ã„ã§ã™(ãŸã ã—èª²é‡‘æ ã«å…¥ã‚Šã¾ã™)ã€‚

on:
  schedule:
    - cron: '5 3 */2 * *'   # éš”æ—¥ï¼ˆUTC 03:05 = JST 12:05ï¼‰
  workflow_dispatch:

concurrency:
  group: supabase-ping
  cancel-in-progress: true

jobs:
  ping-supabase:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: ğŸ“¡ Ping tables (serial with diagnostics + summary)
        run: |
          set -euo pipefail
          set -x

          start_ts=$(date +%s)  # å…¨ä½“ã®è¨ˆæ¸¬é–‹å§‹
          failures=""

          # Step Summary ãƒ˜ãƒƒãƒ€
          {
            echo "## Supabase ping çµæœï¼ˆéš”æ—¥ï¼‰"
            echo ""
            echo "- å®Ÿè¡Œæ™‚åˆ»ï¼ˆJSTï¼‰: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S')"
            echo ""
            echo "| ãƒ†ãƒ¼ãƒ–ãƒ« | HTTP | DNS(resolve) | TCP(connect) | TTFB(starttx) | Total |"
            echo "|---|---:|---:|---:|---:|---:|"
          } >> "$GITHUB_STEP_SUMMARY"

          # å„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é †ç•ªã«Ping
          for table in users_ffprod users_ffprod_archived users_ffdev; do
            echo ""
            echo "ğŸ”¸ $table ã‚’ ping ä¸­..."

            fmt='code=%{http_code} resolve=%{time_namelookup}s connect=%{time_connect}s starttx=%{time_starttransfer}s total=%{time_total}s'

            # è»½ã„ã‚¸ãƒƒã‚¿ãƒ¼ï¼ˆ0ã€œ2ç§’ï¼‰
            sleep $((RANDOM % 3))

            out=$(curl --connect-timeout 10 --max-time 60 \
              --retry 2 --retry-delay 2 --retry-connrefused \
              -L -s -o /dev/null -w "$fmt" \
              -H "apikey: $SUPABASE_KEY" \
              -H "Authorization: Bearer $SUPABASE_KEY" \
              "$SUPABASE_URL/rest/v1/$table?select=*&limit=1")

            echo "[$table] $out"

            # å€¤ã‚’å–ã‚Šå‡ºã—
            code=$(echo "$out" | sed -n 's/.*code=\([0-9][0-9][0-9]\).*/\1/p')
            resolve=$(echo "$out" | sed -n 's/.*resolve=\([0-9.]*s\).*/\1/p')
            connect=$(echo "$out" | sed -n 's/.*connect=\([0-9.]*s\).*/\1/p')
            starttx=$(echo "$out" | sed -n 's/.*starttx=\([0-9.]*s\).*/\1/p')
            total=$(echo "$out" | s
